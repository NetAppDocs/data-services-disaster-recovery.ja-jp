---
sidebar: sidebar 
permalink: use/drplan-create.html 
keywords: disaster recovery, bluexp disaster recovery, failover, failback, replicate, fail over, fail back, vmware, vcenter, replication plan, protection, disaster, recovery, virtual machines, vm 
summary: NetApp Disaster Recovery は、災害復旧ワークフローを自動化するクラウドベースの災害復旧サービスです。  vCenter サイトを追加したら、災害復旧またはレプリケーション プランを作成する準備が整います。 
---
= NetApp Disaster Recoveryでレプリケーションプランを作成する
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/use/


[role="lead"]
vCenter サイトを追加したら、災害復旧またはレプリケーション プランを作成する準備が整います。レプリケーション プランは、VMware インフラストラクチャのデータ保護を管理します。ソースと宛先の vCenter を選択し、リソース グループを選択して、アプリケーションを復元してパワーオンする方法をグループ化します。たとえば、1 つのアプリケーションに関連付けられた仮想マシン (VM) をグループ化したり、同様の層を持つアプリケーションをグループ化したりすることができます。このような計画は、_青写真_と呼ばれることもあります。

*必要なNetAppコンソール ロール* 組織管理者、フォルダまたはプロジェクト管理者、ディザスタ リカバリ管理者、ディザスタ リカバリ フェールオーバー管理者、またはディザスタ リカバリ アプリケーション管理者のロール。

link:../reference/dr-reference-roles.html["NetApp Disaster Recovery におけるユーザーの役割と権限について学習します"] 。https://docs.netapp.com/us-en/bluexp-setup-admin/reference-iam-predefined-roles.html["すべてのサービスに対するNetAppコンソールのアクセスロールについて学習します"^] 。

*このタスクについて*

レプリケーション プランを作成したり、コンプライアンスとテストのスケジュールを編集したりすることもできます。運用ワークロードに影響を与えずに VM のテスト フェイルオーバーを実行します。

複数のデータストア上の複数の VM を保護できます。  NetApp Disaster Recovery は、保護された VM データストアをホストするすべてのONTAPボリュームに対してONTAP整合性グループを作成します。

レプリケーション プランが次のいずれかの状態にある場合にのみ、VM を保護できます。

* 準備完了
* フェイルバックがコミットされました
* テストフェイルオーバーがコミットされました


*レプリケーションプランのスナップショット*

ディザスタ リカバリでは、ソース クラスターと宛先クラスターで同じ数のスナップショットが維持されます。デフォルトでは、サービスは 24 時間ごとにスナップショット調整プロセスを実行し、ソース クラスターと宛先クラスターのスナップショットの数が同じであることを確認します。

次の状況では、ソース クラスターと宛先クラスター間でスナップショットの数が異なる可能性があります。

* 状況によっては、ディザスタ リカバリ以外のONTAP操作によってボリュームからスナップショットが追加または削除されることがあります。
+
** ソース サイトに不足しているスナップショットがある場合、関係のデフォルトのSnapMirrorポリシーに応じて、宛先サイト上の対応するスナップショットが削除される可能性があります。
** 宛先サイトで不足しているスナップショットがある場合、関係のデフォルトのSnapMirrorポリシーに応じて、サービスによって、次にスケジュールされたスナップショット調整プロセス中にソース サイトの対応するスナップショットが削除されることがあります。


* レプリケーション プランのスナップショット保持数を削減すると、新たに削減された保持数を満たすために、ソース サイトと宛先サイトの両方で最も古いスナップショットがサービスによって削除される可能性があります。


このような場合、ディザスタ リカバリでは、次の整合性チェック時にソース クラスターと宛先クラスターから古いスナップショットが削除されます。または、管理者は*アクション*を選択して即時スナップショットのクリーンアップを実行することもできます。image:icon-horizontal-dots.png["水平ドットのアクションメニュー"]レプリケーション プランのアイコンをクリックし、[スナップショットのクリーンアップ] を選択します。

サービスは 24 時間ごとにスナップショットの対称性チェックを実行します。

*始める前に*

SnapMirror関係を作成する前に、Disaster Recovery の外部でクラスタと SVM ピアリングを設定します。

*ベスト プラクティス*: NetApp Disaster Recovery を展開する前に VM を整理して、「データストアの無秩序な増加」を最小限に抑えます。保護が必要な VM をデータストアのサブセットに配置し、保護する必要のない VM をデータストアの別のサブセットに配置します。データストアベースの保護を使用して、特定のデータストア上の VM が確実に保護されるようにします。



== 計画を作成する

ウィザードに従って、次の手順を実行します。

* vCenter サーバーを選択します。
* 複製する VM またはデータストアを選択し、リソース グループを割り当てます。
* ソース環境のリソースが宛先にどのようにマップされるかをマップします。
* プランの実行頻度を設定し、ゲストホスト スクリプトを実行し、ブート順序を設定し、回復ポイントの目標を選択します。
* 計画を見直します。


計画を作成するときは、次のガイドラインに従う必要があります。

* プラン内のすべての VM に同じ資格情報を使用します。
* プラン内のすべての VM に同じスクリプトを使用します。
* プラン内のすべての VM に同じサブネット、DNS、ゲートウェイを使用します。




=== vCenterサーバーを選択

まず、ソース vCenter を選択し、次に宛先 vCenter を選択します。

.手順
. ログイン https://console.netapp.com/["NetAppコンソール"^]。
. NetAppコンソールの左側のナビゲーションから、*保護* > *災害復旧* を選択します。
. NetAppディザスタリカバリ メニューから、*レプリケーション プラン* を選択し、*追加* を選択します。または、サービスを使い始めたばかりの場合は、ダッシュボードから [*レプリケーション プランの追加*] を選択します。
+
image:dr-plan-create-name2.png["レプリケーション プランの追加 > プランの追加ページを示すスクリーンショット"]

. レプリケーション プランの名前を作成します。
. ソース vCenter およびターゲット vCenter リストからソース vCenter とターゲット vCenter を選択します。
. *次へ*を選択します。




=== 複製するアプリケーションを選択し、リソース グループを割り当てます

次のステップは、必要な VM またはデータストアを機能リソース グループにグループ化することです。リソース グループを使用すると、共通のスナップショットを使用して一連の VM またはデータストアを保護できます。

レプリケーション プランでアプリケーションを選択すると、プラン内の各 VM またはデータストアのオペレーティング システムが表示されます。これは、VM またはデータストアをリソース グループにグループ化する方法を決定するのに役立ちます。


TIP: 各リソース グループには、1 つ以上の VM またはデータストアを含めることができます。

リソース グループを作成するときは、次の点を考慮してください。

* データストアをリソース グループに追加する前に、まず VM の手動検出またはスケジュールされた検出を開始します。これにより、VM が検出され、リソース グループにリストされるようになります。手動検出をトリガーしないと、VM がリソース グループにリストされない可能性があります。
* データストアに少なくとも 1 つの VM があることを確認します。データストアに VM がない場合、データストアは検出されません。
* 単一のデータストアは、複数のレプリケーション プランによって保護されている VM をホストしないでください。
* 保護された VM と保護されていない VM を同じデータストアにホストしないでください。保護された VM と保護されていない VM が同じデータストアでホストされている場合、次の問題が発生する可能性があります。
+
** NetApp Disaster Recovery はSnapMirrorを使用し、システムがONTAPボリューム全体を複製するため、そのボリュームの使用容量がライセンスの考慮に使用されます。この場合、保護された VM と保護されていない VM の両方によって消費されるボリューム スペースがこの計算に含まれます。
** リソース グループとそれに関連付けられたデータストアを災害復旧サイトにフェイルオーバーする必要がある場合、保護されていない VM (リソース グループの一部ではないが、 ONTAPボリュームでホストされている VM) はフェイルオーバー プロセスによってソース サイトに存在しなくなり、その結果、ソース サイトで保護されていない VM に障害が発生します。また、 NetApp Disaster Recovery では、フェールオーバー vCenter サイトで保護されていない VM を起動しません。


* VM を保護するには、VM をリソース グループに含める必要があります。


*ベスト プラクティス*: フェイルオーバー テスト用に別の専用マッピング セットを作成し、同じ IP アドレスを使用して VM が実稼働ネットワークに接続されるのを防ぎます。

.手順
. *仮想マシン*または*データストア*を選択します。
. 必要に応じて、特定の VM またはデータストアを名前で検索します。
. 「アプリケーション」ページの左側で、保護する VM またはデータストアを選択し、選択したグループに割り当てます。
+
ソース vCenter はオンプレミスの vCenter 上に存在している必要があります。ターゲット vCenter は、同じサイトまたはリモート サイト内の 2 番目のオンプレミス vCenter、または VMware Cloud on AWS などのクラウドベースのソフトウェア定義データセンター (SDDC) にすることができます。両方の vCenter はすでにBlueXP disaster recovery作業環境に追加されているはずです。

+
選択したリソースは自動的にグループ 1 に追加され、新しいグループ 2 が開始されます。最後のグループにリソースを追加するたびに、別のグループが追加されます。

+
image:dr-plan-create-apps-vms6.png["「レプリケーション プランの追加」>「レプリケーションするアプリケーション」ページを示すスクリーンショット"]

+
または、データストアの場合:

+
image:dr-plan-create-apps-datastores.png["「レプリケーション プランの追加」>「レプリケーションするアプリケーション」ページを示すスクリーンショット"]

. 必要に応じて、次のいずれかを実行します。
+
** グループの名前を変更するには、グループの*編集*をクリックします。image:icon-pencil.png["鉛筆アイコン"]アイコン。
** グループからリソースを削除するには、リソースの横にある *X* を選択します。
** リソースを別のグループに移動するには、新しいグループにドラッグ アンド ドロップします。
+

TIP: データストアを別のリソース グループに移動するには、不要なデータストアの選択を解除し、レプリケーション プランを送信します。次に、他のレプリケーション プランを作成または編集し、データストアを再度選択します。



. *次へ*を選択します。




=== ソースリソースをターゲットにマッピングする

リソース マッピング ステップでは、ソース環境のリソースをターゲットにどのようにマッピングするかを指定します。レプリケーション プランを作成するときに、プラン内の各 VM のブート遅延と順序を設定できます。これにより、VM の起動順序を設定できます。

DR 計画の一環としてテスト フェールオーバーを実行する予定の場合は、フェールオーバー テスト中に起動された VM が運用 VM に干渉しないように、一連のテスト フェールオーバー マッピングを提供する必要があります。これを実現するには、テスト VM に異なる IP アドレスを提供するか、テスト VM の仮想 NIC を、運用環境から分離されているが同じ IP 構成を持つ別のネットワーク (_バブル_ または _テスト ネットワーク_ と呼ばれる) にマッピングします。

.開始する前に
このサービスでSnapMirror関係を作成する場合は、クラスタとその SVM ピアリングがNetApp Disaster Recovery の外部ですでに設定されている必要があります。

.手順
. リソース マッピング ページで、フェールオーバーとテスト操作の両方に同じマッピングを使用するには、チェックボックスをオンにします。
+
image:dr-plan-resource-mapping2.png["レプリケーションプラン、リソースマッピングタブ"]

. フェールオーバー マッピング タブで、各リソースの右側にある下矢印を選択し、各セクションのリソースをマッピングします。
+
** コンピューティングリソース
** 仮想ネットワーク
** 仮想マシン
** データストア






=== マップリソース > コンピューティングリソースセクション

コンピューティング リソース セクションでは、フェイルオーバー後に VM が復元される場所を定義します。ソース vCenter データセンターとクラスタをターゲット データセンターとクラスタにマップします。

オプションで、特定の vCenter ESXi ホストで VM を再起動できます。  VMWare DRS が有効になっている場合は、DR で構成されたポリシーを満たすために必要に応じて、VM を代替ホストに自動的に移動できます。

オプションで、このレプリケーション プラン内のすべての VM を vCenter の一意のフォルダーに配置できます。これにより、vCenter 内でフェールオーバーされた VM をすばやく整理する簡単な方法が提供されます。

*コンピューティング リソース* の横にある下矢印を選択します。

* *ソースデータセンターとターゲットデータセンター*
* *ターゲットクラスター*
* *ターゲット ホスト* (オプション): クラスターを選択した後、この情報を設定できます。



TIP: vCenter にクラスタ内の複数のホストを管理するように構成された Distributed Resource Scheduler (DRS) がある場合は、ホストを選択する必要はありません。ホストを選択すると、 NetApp Disaster Recovery はすべての VM を選択したホストに配置します。  * *ターゲット VM フォルダー* (オプション): 選択した VM を保存するための新しいルート フォルダーを作成します。



=== マップリソース > 仮想ネットワークセクション

VM は仮想ネットワークに接続された仮想 NIC を使用します。フェイルオーバー プロセスでは、サービスはこれらの仮想 NIC を、宛先の VMware 環境で定義された仮想ネットワークに接続します。リソース グループ内の VM によって使用されるソース仮想ネットワークごとに、サービスでは宛先仮想ネットワークの割り当てが必要です。


NOTE: 複数のソース仮想ネットワークを同じターゲット仮想ネットワークに割り当てることができます。ただし、これにより IP ネットワーク構成の競合が発生する可能性があります。複数のソース ネットワークを単一のターゲット ネットワークにマップして、すべてのソース ネットワークの構成が同じになるようにすることができます。

フェールオーバー マッピング タブで、*仮想ネットワーク* の横にある下矢印を選択します。ソース仮想 LAN とターゲット仮想 LAN を選択します。

適切な仮想 LAN へのネットワーク マッピングを選択します。仮想 LAN はすでにプロビジョニングされているはずなので、適切な仮想 LAN を選択して VM をマップします。



=== マップリソース > 仮想マシンセクション

次のいずれかのオプションを設定することで、レプリケーション プランによって保護されるリソース グループ内の各 VM を、宛先の vCenter 仮想環境に適合するように構成できます。

* 仮想CPUの数
* 仮想DRAMの量
* IPアドレスの設定
* フェイルオーバープロセスの一部としてゲストOSシェルスクリプトを実行する機能
* 固有のプレフィックスとサフィックスを使用してフェイルオーバーされたVM名を変更する機能
* VMフェイルオーバー時の再起動順序を設定する機能


フェールオーバー マッピング タブで、*仮想マシン* の横にある下矢印を選択します。

VM のデフォルトがマップされます。デフォルトのマッピングでは、VM が実稼働環境で使用するのと同じ設定 (同じ IP アドレス、サブネット マスク、ゲートウェイ) が使用されます。

デフォルト設定を変更する場合は、[ターゲット IP] フィールドを [ソースと異なる] に変更する必要があります。


NOTE: 設定を「ソースと異なる」に変更する場合は、VM ゲスト OS の資格情報を提供する必要があります。

このセクションには、選択内容に応じて異なるフィールドが表示される場合があります。

フェールオーバーされた各 VM に割り当てられる仮想 CPU の数を増減できます。ただし、各 VM には少なくとも 1 つの仮想 CPU が必要です。各 VM に割り当てられる仮想 CPU と仮想 DRAM の数を変更できます。デフォルトの仮想 CPU および仮想 DRAM 設定を変更する最も一般的な理由は、ターゲット vCenter クラスタ ノードに、ソース vCenter クラスタと同じ数の使用可能なリソースがない場合です。

*ネットワーク設定* ディザスタ リカバリでは、VM ネットワークの広範な構成オプションがサポートされています。ターゲット サイトに、ソース サイトの運用仮想ネットワークとは異なる TCP/IP 設定を使用する仮想ネットワークがある場合は、これらを変更する必要がある場合があります。

最も基本的な (そしてデフォルトの) レベルでは、設定は、ソース サイトで使用されているものと同じ TCP/IP ネットワーク設定を、宛先サイトの各 VM に対して単純に使用します。これには、ソース仮想ネットワークと宛先仮想ネットワークで同じ TCP/IP 設定を構成する必要があります。

このサービスは、VM の静的または動的ホスト構成プロトコル (DHCP) IP 構成のネットワーク設定をサポートします。  DHCP は、ホスト ネットワーク ポートの TCP/IP 設定を動的に構成する標準ベースの方法を提供します。  DHCP は、少なくとも TCP/IP アドレスを提供する必要があり、デフォルト ゲートウェイ アドレス (外部インターネット接続へのルーティング用)、サブネット マスク、および DNS サーバー アドレスも提供できます。  DHCP は、従業員のデスクトップ、ラップトップ、携帯電話の接続などのエンドユーザー コンピューティング デバイスによく使用されますが、サーバーなどのあらゆるネットワーク コンピューティング デバイスにも使用できます。

* *同じサブネット マスク、DNS、およびゲートウェイ設定を使用する* オプション: これらの設定は通常、同じ仮想ネットワークに接続されているすべての VM で同じであるため、これらを一度構成して、レプリケーション プランによって保護されているリソース グループ内のすべての VM に対してディザスター リカバリーでその設定を使用する方が簡単な場合があります。一部の VM が異なる設定を使用する場合は、このチェックボックスをオフにして、各 VM に対してそれらの設定を提供する必要があります。
* *IP アドレスの種類*: ターゲットの仮想ネットワークの要件に合わせて VM の構成を再構成します。 NetApp Disaster Recovery には、DHCP または静的 IP の 2 つのオプションがあります。静的 IP の場合は、サブネット マスク、ゲートウェイ、および DNS サーバーを構成します。さらに、VM の資格情報を入力します。
+
** *DHCP*: VM が DHCP サーバーからネットワーク構成情報を取得するようにする場合は、この設定を選択します。このオプションを選択した場合は、VM の資格情報のみを指定します。
** *静的 IP*: IP 構成情報を手動で指定する場合は、この設定を選択します。次のいずれかを選択できます: ソースと同じ、ソースと異なる、またはサブネット マッピング。ソースと同じものを選択した場合は、資格情報を入力する必要はありません。一方、ソースとは異なる情報を使用する場合は、資格情報、VM の IP アドレス、サブネット マスク、DNS、ゲートウェイ情報を提供できます。  VM ゲスト OS の資格情報は、グローバル レベルまたは各 VM レベルのいずれかに提供する必要があります。
+
これは、大規模な環境を小規模なターゲット クラスターにリカバリする場合や、1 対 1 の物理 VMware インフラストラクチャをプロビジョニングせずに災害復旧テストを実施する場合に非常に役立ちます。

+
image:dr-plan-vm-subnet-option2.png["レプリケーション プランの追加 > リソース マッピング > 仮想マシンを示すスクリーンショット"]



* *スクリプト*: .sh、.bat、または .ps1 形式のカスタム ゲスト OS ホスト スクリプトをポスト プロセスとして含めることができます。カスタム スクリプトを使用すると、 BlueXP disaster recoveryは、フェイルオーバー、フェイルバック、および移行プロセスの後にスクリプトを実行できます。たとえば、フェイルオーバーが完了した後、カスタム スクリプトを使用してすべてのデータベース トランザクションを再開できます。このサービスは、Microsoft Windows またはコマンドライン パラメータがサポートされている任意の Linux バリアントを実行している VM 内でスクリプトを実行できます。スクリプトを個々の VM に割り当てることも、レプリケーション プラン内のすべての VM に割り当てることもできます。
+
VM ゲスト OS でスクリプトの実行を有効にするには、次の条件を満たす必要があります。

+
** VM に VMware Tools がインストールされている必要があります。
** スクリプトを実行するには、適切なゲスト OS 権限を持つ適切なユーザー資格情報を提供する必要があります。
** 必要に応じて、スクリプトのタイムアウト値（秒単位）を含めます。
+
*Microsoft Windows を実行している VM*: Windows バッチ (.bat) または PowerShell (ps1) スクリプトのいずれかを実行できます。 Windows スクリプトではコマンドライン引数を使用できます。各引数をフォーマットする `arg_name$value`フォーマット、ここで `arg_name`は引数の名前であり、 `$value`は引数の値であり、セミコロンで区切られます。 `argument$value`ペア。

+
*Linux を実行する VM*: VM で使用される Linux バージョンでサポートされている任意のシェル スクリプト (.sh) を実行できます。 Linux スクリプトではコマンドライン引数を使用できます。セミコロンで区切られた値のリストで引数を指定します。名前付き引数はサポートされていません。各引数を `Arg[x]`引数リストとポインタを使用して各値を参照します。 `Arg[x]`例えば、配列 `value1;value2;value3`。



* *ターゲット VM のプレフィックスとサフィックス*: 仮想マシンの詳細で、フェールオーバーされた各 VM 名にプレフィックスとサフィックスをオプションで追加できます。これは、フェールオーバーされた VM と、同じ vCenter クラスター上で実行されている本番環境の VM を区別するのに役立ちます。たとえば、VM 名にプレフィックス「DR-」とサフィックス「-failover」を追加できます。災害発生時に別のサイトで一時的に VM をホストするために、2 番目の本番 vCenter を追加する人もいます。プレフィックスまたはサフィックスを追加すると、フェールオーバーされた VM をすばやく識別できるようになります。カスタム スクリプトでプレフィックスまたはサフィックスを使用することもできます。
+
コンピューティング リソース セクションでターゲット VM フォルダーを設定する別の方法を使用することもできます。

* *ソース VM の CPU と RAM*: 仮想マシンの詳細で、必要に応じて VM の CPU と RAM のパラメータのサイズを変更できます。
+

NOTE: DRAM はギガバイト (GiB) またはメガバイト (MiB) で構成できます。各 VM に少なくとも 1 MiB の RAM が必要ですが、実際の量は VM ゲスト OS と実行中のアプリケーションが効率的に動作できるようにする必要があります。

+
image:dr-plan-resource-mapping-vm-boot-order.png["レプリケーション プランの追加 > リソース マッピング > 仮想マシンを示すスクリーンショット"]

* *ブート順序*: フェールオーバー後に、リソース グループ全体で選択したすべての仮想マシンのブート順序を変更できます。デフォルトでは、すべての VM が同時に並行して起動しますが、この段階で変更を加えることができます。これは、後続の優先度の VM が起動される前に、優先度 1 の VM がすべて実行されていることを確認するのに役立ちます。
+
BlueXP disaster recoveryは、同じブート順序番号を持つすべての VM を並行してブートします。

+
** シーケンシャル ブート: 各 VM に一意の番号を割り当てて、割り当てられた順序 (例: 1、2、3、4、5) で VM を起動します。
** 同時起動: 同時に起動するには、すべての VM に同じ番号を割り当てます (例: 1、1、1、1、2、2、3、4、4)。


* *ブート遅延*: ブートアクションの遅延を分単位で調整し、VM が電源オンプロセスを開始する前に待機する時間を示します。  0～10 分までの値を入力します。
+

TIP: 起動順序をデフォルトにリセットするには、「*VM 設定をデフォルトにリセット*」を選択し、デフォルトに戻す設定を選択します。

* *アプリケーション整合性のあるレプリカを作成する*: アプリケーション整合性のあるスナップショット コピーを作成するかどうかを示します。サービスはアプリケーションを静止させ、スナップショットを取得してアプリケーションの一貫した状態を取得します。この機能は、Windows および Linux 上で実行されている Oracle と、Windows 上で実行されている SQL Server でサポートされています。次に詳細をご覧ください。
* *Windows LAPS を使用する*: Windows ローカル管理者パスワード ソリューション (Windows LAPS) を使用している場合は、このボックスをオンにします。このオプションは、「静的 IP」オプションを選択した場合にのみ使用できます。このボックスをチェックすると、仮想マシンごとにパスワードを入力する必要がなくなります。代わりに、ドメイン コントローラーの詳細を提供します。
+
Windows LAPS を使用しない場合、VM は Windows VM であり、VM 行の資格情報オプションが有効になります。  VM の資格情報を提供できます。

+
image:dr-plan-resource-mapping-vm-boot-order.png["レプリケーション プランの追加 > リソース マッピング > 仮想マシンを示すスクリーンショット"]





==== アプリケーション整合性のあるレプリカを作成する

多くの VM は、Oracle や Microsoft SQL Server などのデータベース サーバーをホストします。これらのデータベース サーバーでは、スナップショットが取得されたときにデータベースが一貫した状態であることを保証するために、アプリケーション整合性のあるスナップショットが必要です。

アプリケーション整合性スナップショットにより、スナップショットが取得されたときにデータベースが整合性のある状態であることが保証されます。これは、フェイルオーバーまたはフェイルバック操作後にデータベースを一貫した状態に復元できることを保証するため重要です。

データベース サーバーによって管理されるデータは、データベース サーバーをホストしている VM と同じデータストアでホストされる場合もあれば、別のデータストアでホストされる場合もあります。次の表は、ディザスタ リカバリにおけるアプリケーション整合性スナップショットでサポートされている構成を示しています。

[cols="20,20,40a"]
|===
| データの場所 | サポート | 注記 


| VMと同じvCenterデータストア内 | はい  a| 
データベース サーバーとデータベースは両方とも同じデータストアに存在するため、フェイルオーバー時にはサーバーとデータの両方が同期されます。



| VMとは異なるvCenterデータストア内 | いいえ  a| 
ディザスタ リカバリでは、データベース サーバーのデータが異なる vCenter データストアにあるかどうかを識別できません。このサービスではデータを複製することはできませんが、データベース サーバー VM を複製することはできます。

データベース データは複製できませんが、このサービスにより、VM バックアップ時にデータベースが停止していることを確認するために必要なすべての手順がデータベース サーバーで実行されるようになります。



| 外部データソース内 | いいえ  a| 
データがゲストマウントされた LUN または NFS 共有に存在する場合、Disaster Recovery はデータを複製できませんが、データベース サーバー VM を複製できます。

データベース データは複製できませんが、このサービスにより、VM バックアップ時にデータベースが停止していることを確認するために必要なすべての手順がデータベース サーバーで実行されるようになります。

|===
スケジュールされたバックアップ中に、Disaster Recovery はデータベース サーバーを静止させ、データベース サーバーをホストしている VM のスナップショットを取得します。これにより、スナップショットが取得されたときにデータベースが一貫した状態になることが保証されます。

* Windows VM の場合、サービスは Microsoft ボリューム シャドウ コピー サービス (VSS) を使用していずれかのデータベース サーバーと調整します。
* Linux VM の場合、サービスは一連のスクリプトを使用して Oracle サーバーをバックアップ モードにします。


VM とそのホスティング データストアのアプリケーション整合性レプリカを有効にするには、各 VM の [*アプリケーション整合性レプリカを作成する*] の横にあるボックスをオンにし、適切な権限を持つゲスト ログイン資格情報を提供します。



=== マップリソース > データストアセクション

VMware データストアは、 ONTAP FlexVolボリューム、または VMware VMFS を使用するONTAP iSCSI または FC LUN 上でホストされます。データストア セクションを使用して、ディスク上のデータを宛先に複製するためのターゲットONTAPクラスタ、ストレージ仮想マシン (SVM)、およびボリュームまたは LUN を定義します。

*データストア*の横にある下矢印を選択します。VM の選択に基づいて、データストア マッピングが自動的に選択されます。

このセクションは、選択内容に応じて有効または無効になります。

image:dr-plan-datastore-platform.png["レプリケーション プランの追加 > リソース マッピング > データストアを示すスクリーンショット"]

* *プラットフォーム管理のバックアップと保持スケジュールを使用する*: 外部のスナップショット管理ソリューションを使用している場合は、このチェックボックスをオンにします。 NetApp Disaster Recovery は、ネイティブのONTAP SnapMirrorポリシー スケジューラやサードパーティ統合などの外部スナップショット管理ソリューションの使用をサポートしています。レプリケーション プラン内のすべてのデータストア (ボリューム) に、別の場所で管理されているSnapMirror関係がすでに存在する場合は、それらのスナップショットをNetApp Disaster Recovery のリカバリ ポイントとして使用できます。
+
このオプションを選択すると、 NetApp Disaster Recovery はバックアップ スケジュールを構成しません。ただし、テスト、フェイルオーバー、フェイルバック操作のためにスナップショットが作成される可能性があるため、保持スケジュールを構成する必要があります。

+
これが構成されると、サービスは定期的にスケジュールされたスナップショットを取得せず、代わりに外部エンティティに依存してスナップショットを取得および更新します。

* *開始時刻*: バックアップと保持の実行を開始する日時を入力します。
* *実行間隔*: 時間間隔を時間と分で入力します。たとえば、1 時間を入力すると、サービスは 1 時間ごとにスナップショットを作成します。
* *保持数*: 保持するスナップショットの数を入力します。
+

TIP: 保持されるスナップショットの数と各スナップショット間のデータ変更率によって、ソースと宛先の両方で消費されるストレージ容量が決まります。保持するスナップショットの数が増えるほど、消費されるストレージ容量も増えます。

* *ソースおよびターゲット データストア*: 複数の (ファンアウト) SnapMirror関係が存在する場合は、使用する宛先を選択できます。ボリュームにSnapMirror関係がすでに確立されている場合は、対応するソース データストアとターゲット データストアが表示されます。ボリュームにSnapMirror関係がない場合は、ターゲット クラスタを選択し、ターゲット SVM を選択して、ボリューム名を指定することで、今すぐ SnapMirror 関係を作成できます。サービスはボリュームとSnapMirror の関係を作成します。
+

NOTE: このサービスでSnapMirror関係を作成する場合は、クラスタとその SVM ピアリングがNetApp Disaster Recovery の外部ですでに設定されている必要があります。

+
** VM が同じボリュームと同じ SVM からのものである場合、サービスは標準のONTAPスナップショットを実行し、セカンダリ デスティネーションを更新します。
** VM が異なるボリュームと同じ SVM からのものである場合、サービスはすべてのボリュームを含めて整合性グループのスナップショットを作成し、セカンダリ デスティネーションを更新します。
** VM が異なるボリュームおよび異なる SVM からのものである場合、サービスは同じまたは異なるクラスター内のすべてのボリュームを含めて、整合性グループ開始フェーズおよびコミット フェーズのスナップショットを実行し、セカンダリ デスティネーションを更新します。
** フェイルオーバー中は、任意のスナップショットを選択できます。最新のスナップショットを選択した場合、サービスはオンデマンド バックアップを作成し、宛先を更新し、そのスナップショットをフェールオーバーに使用します。


* *優先 NFS LIF* と *エクスポート ポリシー*: 通常、サービスによって優先 NFS LIF とエクスポート ポリシーが選択されます。特定の NFS LIF またはエクスポート ポリシーを使用する場合は、各フィールドの横にある下矢印を選択し、適切なオプションを選択します。
+
オプションで、フェイルオーバー イベント後にボリュームの特定のデータ インターフェイス (LIF) を使用することもできます。これは、ターゲット SVM に複数の LIF がある場合に、データ トラフィックのバランスをとるのに役立ちます。

+
NAS データ アクセス セキュリティをさらに制御するために、このサービスでは、異なるデータストア ボリュームに固有の NAS エクスポート ポリシーを割り当てることができます。エクスポート ポリシーは、データストア ボリュームにアクセスする NFS クライアントのアクセス制御ルールを定義します。エクスポート ポリシーを指定しない場合、サービスは SVM のデフォルトのエクスポート ポリシーを使用します。



*ベスト プラクティス*: 保護された VM をホストするソースとターゲットの vCenter ESXi ホストのみにボリューム アクセスを制限する専用のエクスポート ポリシーを作成することを強くお勧めします。これにより、外部エンティティが NFS エクスポートにアクセスできないようになります。



=== テストフェイルオーバーマッピングを追加する

.手順
. テスト環境に異なるマッピングを設定するには、ボックスのチェックを外して、[テスト マッピング] タブを選択します。
. 前と同じように各タブを確認しますが、今回はテスト環境です。
+
テスト マッピング タブでは、仮想マシンとデータストアのマッピングが無効になっています。

+

TIP: 後で計画全体をテストできます。現在、テスト環境のマッピングを設定しています。





=== レプリケーション計画を確認する

最後に、少し時間を取ってレプリケーション プランを確認します。


TIP: 後でレプリケーション プランを無効にしたり削除したりできます。

.手順
. 各タブ（プランの詳細、フェールオーバー マッピング、VM）の情報を確認します。
. *プランを追加*を選択します。
+
プランがプランのリストに追加されます。





== コンプライアンスをテストし、フェイルオーバー テストが機能することを確認するためにスケジュールを編集します

コンプライアンス テストとフェールオーバー テストをテストするスケジュールを設定して、必要に応じて正しく機能することを確認できるようにすることをお勧めします。

* *コンプライアンス時間の影響*: レプリケーション プランが作成されると、サービスはデフォルトでコンプライアンス スケジュールを作成します。デフォルトのコンプライアンス時間は 30 分です。この時間を変更するには、レプリケーション プランのスケジュールを編集します。
* *フェールオーバーの影響をテスト*: フェールオーバー プロセスをオンデマンドまたはスケジュールに従ってテストできます。これにより、レプリケーション プランで指定された宛先への仮想マシンのフェールオーバーをテストできます。
+
テスト フェイルオーバーでは、 FlexCloneボリュームが作成され、データストアがマウントされ、そのデータストア上のワークロードが移動されます。テスト フェイルオーバー操作は、実稼働ワークロード、テスト サイトで使用されるSnapMirror関係、および正常に動作し続ける必要がある保護されたワークロードには影響しません。



スケジュールに基づいてフェイルオーバー テストが実行され、ワークロードがレプリケーション プランで指定された宛先に移動されていることが確認されます。

.手順
. NetAppディザスタリカバリ メニューから、*レプリケーション プラン* を選択します。
+
image:dr-plan-list.png["レプリケーションプランのリストを示すスクリーンショット"]

. *アクション*を選択しますimage:icon-horizontal-dots.png["水平ドットのアクションメニュー"]アイコンをクリックし、[スケジュールの編集] を選択します。
. NetApp Disaster Recovery でテストのコンプライアンスをチェックする頻度を分単位で入力します。
. フェールオーバー テストが正常であることを確認するには、[*フェールオーバーを毎月実行する*] をオンにします。
+
.. これらのテストを実行する月日と時刻を選択します。
.. テストを開始する日付を yyyy-mm-dd 形式で入力します。
+
image:dr-plan-schedule-edit2.png["スケジュールを編集できる場所を示すスクリーンショット"]



. *スケジュールされたテスト フェイルオーバーにオンデマンド スナップショットを使用する*: 自動テスト フェイルオーバーを開始する前に新しいスナップショットを取得するには、このボックスをオンにします。
. フェールオーバー テストが終了した後にテスト環境をクリーンアップするには、[テスト フェールオーバー後に自動的にクリーンアップする] をオンにし、クリーンアップを開始する前に待機する分数を入力します。
+

NOTE: このプロセスでは、テスト場所から一時 VM を登録解除し、作成されたFlexCloneボリュームを削除し、一時データストアをマウント解除します。

. *保存*を選択します。

